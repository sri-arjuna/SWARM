#!/usr/bin/env bash
##############################################
# SWARM = Shell Wrapper and Runtime Modifier #
# Author:	Simon Arjuna Erat (sea)	     #
# License:	GPL v2			     #
# Copyleft:	1995-2020		     #
# Created:	2020.01.18		     #
# Changed:	2020.06.05	 	     #
# Build:	48			     #
##############################################
#
#	SWARM is the successor of TUI (Text User Interace)
#	It is an interface between script authors and end users.
#	In doing so, the scripts you write,
#	will appear application-like to an end user.
#
#	This file is to be called from your script like eiter one of:
#	source ./runtime
#	source ./SWARM/runtime
#
#	To get started writing scripts, call this file like eiter one of:
#	./runtime help
#	./runtime manual
#	./runtime docs
#
#	To change settings, you can use eiter one of:
#	./runtime config
#	swarm.userconfig.edit
#	edit "$HOME/.swarmrc" "$HOME/.config/swarm/"
#
##############################################
# Requirements:
# * BASH 4.3+
# * GNU Coreutils 8.25
# *
#
# Speed increase:
# * Make sure '$HOME' is set and exists for all shell login accounts.
# * Preset SWARMDIR=/path/to/SWARM
#
# RAMDISK
# As root you can force the use of a RAMDISK
# for configuration, log- and possible tempfiles.
# If you should enounter a R(ead)O(nly)-system, logs and
# config files will be disabled, unless you:
# * Preset SWARM_RAMDISK=true
# * Optionaly, you may pass SWARM_RAMDISK_DIR=/path/to/mountpoint
##############################################
#
# Core Public Variables
#
	# SWARM
	${DEBUG:-false} && set -x
	# shellcheck disable=SC2086 disable=SC2184
	unset SWARM[@] ${!SWARM_DIR_*} IFS >/dev/zero
	declare -A SWARM
	# isSWARMfirstTime will be set to false if SWARMRC (~/.swarmrc) is found
	export isSWARMfirstTime=true
	# hasCOLUMNS is for internal use only
	# shellcheck disable=SC2015
	[[ -n "$COLUMNS" ]] && \
		export hasCOLUMNS=true || \
		export hasCOLUMNS=false
	export hasCOLUMNS=false
	#echo $hasCOLUMNS;exit
	SWARM[VERSION]=0.8
	SWARM[BUILD]=49
	SWARM[AUTHOR]="Simon Arjuna Erat (sea)"
	SWARM[GIT]="http://github.com/sri-arjuna/swarm"
	SWARM[LICENSE]="GPLv2"
	# This is default 'highlighted' MACHINE or ROOT display
	# Non-root users (if existing) have very hardcoded 'default-blue' (fallback) theme
	SWARM[THEME]="default-red"
	SWARM[ROOTDIR]=""
	# Language must be pre-set up until the basic language file was loaded
	SWARM[LANG]="en_GB"
	export SWARM_CODE=$$
#
# Set first time default
#
#	This is just ment as failsafe if PATH is not set
#	to get the most elementary basics on/of most systems
	posix_PATH="/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin"
	configure_PATH="$BINDIR:$SBINDIR"
	os_PATH=":$OS_DIR_BIN:$OS_DIR_SBIN"
	export PATH_OLD="$PATH"
	export PATH="${PATH:-$posix_PATH}:$configure_PATH:$os_PATH"
	# Make sure TERM is set
	TERM="${TERM:-GNU\057Linux}"
	# Most basic commands ; do not change (But pre-set these variables in the shell for first use)!
	# This WILL be overwritten by the SWARMRC (~/.swarmrc)
	export PRINTF=${PRINTF:-\printf}
	export ECHO="swarm.util.echo"		# Defined in core.utils
	export AWK=${AWK:-\gawk}
	export GREP=${GREP:-\grep}
	export SED=${SED:-\sed}
	export WHICH="swarm.util.which"	# Defined in core.utils
	export LS=${LS:-\ls}
	export PWD_EXEC=${PWD_EXEC:-\pwd}
	export DATE=${DATE:-\date}
	export MKDIR="swarm.util.mkdir"	# Defined in core.utils
	export TOUCH=${TOUCH:-\touch}
	export PWD_EXEC=${PWD_EXEC:-\pwd}
	export TPUT="${TPUT:-tput}"
	# SU and SUDO must be empty if the command was not found
	export SU=${SU}
	export SUDO=${SUDO}
	export ID=${ID:-\id}
	export WHOAMI=${WHOAMI:-\whoami}
	export SORT=${SORT:-\sort}		# NOT a GNU coreutil
	export LS=${LS:-\ls}
	export RM=${RM:-\rm}
	export RMDIR=${RMDIR:-\rmdir}
	export FIND=${FIND:-\find}
	export TR=${TR:-\tr}
	export WC=${WC:-\wc}
#
# Some other things
#
	# Need to get these updating them self upon call
	# Use these to set the date variable: `
	export DATE_TODAY="$DATE +%F"
	export DATE_TIME="$DATE +%T"
	export DATE_TIME_LOG="$DATE +%T.%s"
#
# Get proper SWARM root dir
#
	# If no SWARMDIR is provided, it is used in runtime as designed
	# However, 'SWARMDIR=$PWD/SWARM source SWARM/runtime' could be used as a speedbooster,
	# as it bypasses the multiple physical read attempts
	# SWARMDIR - MUST - be provided if you intend to store
	# the files in a dir not named SWARM
	if [[ "x" == "x$SWARMDIR" ]]
	then
		# Find the path that holds this script
		# Evaluate best chance for the dirs
		for tmp in $0 ${PWD:-$($PWD_EXEC)} .. ${PWD:-$($PWD_EXEC)}/..
		do
			if [[ "SWARM" == "${tmp##*/}" ]]
			then	# We're in it already
				# Usualy debug or tryout mode
				SWARM[ROOTDIR]="$tmp"
				unset tmp
				break
			fi

			if [[ -d "${tmp}/SWARM" ]]
			then	# It's a sub dir
				# As it should be called
				SWARM[ROOTDIR]="$tmp/SWARM"
				unset tmp
				break
			fi
		done
		# Should not reach this point
		# Other than while debug testing
		[[ -f ./runtime ]] && SWARM[ROOTDIR]="${PWD:-${PWD_EXEC}}"
		unset tmp
	else
		# Or optionaly, use the 'install' method
		# Verify the location
		if [[ -f "${SWARMDIR}/runtime" ]]
		then	# Assign the variable
			SWARM[ROOTDIR]="$SWARMDIR"
		else	# This is the only hardcoded 'english only' message
			$PRINTF '%s\n' "Fatal, provided SWARMDIR=$SWARMDIR dir not found - assumed: \"${SWARM[ROOTDIR]}\" and you are in ${PWD:-$(${PWD_EXEC})}."
			sleep 3
			return 1
		fi
	fi
#
# SWARM_DIR_* for proper re-use
# source this file and type: SWARM_DIR_<hit tabulator>
#
	# Some might wonder why I did not use BASH_SOURCE[0]
	# -> Because if it was sourced with a relative reference,
	# I would not get an abslute path
	export SWARM_DIR_ROOT=${SWARM[ROOTDIR]}
	export SWARM_DIR_DOCS="${SWARM_DIR_ROOT}/docs"
	export SWARM_DIR_DATA="${SWARM_DIR_ROOT}/data"
	export SWARM_DIR_CONF="${SWARM_DIR_DATA}/conf"
	export SWARM_DIR_LIBS="${SWARM_DIR_DATA}/libs"
	export SWARM_DIR_LANG="${SWARM_DIR_DATA}/lang"
	export SWARM_DIR_LIST="${SWARM_DIR_DATA}/lists"
	export SWARM_DIR_THEMES="${SWARM_DIR_DATA}/themes"
	export SWARM_DIR_TEMPLATES="${SWARM_DIR_DATA}/templates"
#
# Load english strings for overall coverage for error messages.
#
	for lang_file in "$SWARM_DIR_LANG/en_GB"/{core,usage}.conf
	do
		# shellcheck disable=SC1090
		source "$lang_file"
		$PRINTF "."
	done
#
# Load SWARM settings, core and sanity functions
#
	declare tmp_swarm_loading="" \
			tmp_len=0 \
			tmp_empty=""

	for thisCFG in "${SWARM_DIR_CONF}"/* "${SWARM_DIR_LIBS}"/core.env
	do
		# shellcheck disable=SC1090
		source "$thisCFG"
		$PRINTF "."
	done
#
# SWARM Environment checks
#

	for this in "${SWARM_DIR_LIBS}"/*
	do
		# Skip if core.utils or core.sanity
		#( [[ "$this" == "$SWARM_DIR_LIBS/core.utils" ]] || [[ "$this" == "$SWARM_DIR_LIBS/core.sanity" ]] ) && continue
		[[ "$this" == "$SWARM_DIR_LIBS/core.env" ]] && continue
		# Special handling for slow-mode
		if ${doSlowLoading:-false}
		then
			# This is off by default because nowadays it's too fast to see the regular way
			# Only recomended with numbers between 0.5 to 2 for application-like scripts
			# To have a 'cool intro'
			$PRINTF '\r%s' "$this"
			[[ $tmp_len -lt ${#this} ]] && \
					tmp_len=${#this} && \
					tmp_empty=$($PRINTF '%*s' $COLUMNS)
			sleep "${SWARM_INTERVALL_SLOW_LOADING:-0.3}"
			$PRINTF  "\r$tmp_empty"
		fi

		# Minimalistic output
		tmp_swarm_loading="${tmp_swarm_loading}."
		if [[ ! "${this:0:2}" == "\.[\.]" ]]
		then	# shellcheck disable=SC1090
			if source "$this"
			then	# All good
				$PRINTF '\r%s' "${tmp_swarm_loading}"
				 ${doLogExt:-false} && \
				 	init.msg.log "$SWARM_MSG_INIT_FILE_FOUND $this"
			else	# Not good
				 ${doLogExt:-false} &&  \
					 init.log "$SWARM_MSG_INIT_FILE_MISSING $this"
			fi
		#else
		#	[[ "*" == "$this" ]] || $PRINTF '%s\n' "$SWARM_MSG_INIT_FILE_MISSING $this"
		fi
	done
	unset tmp_swarm_loading \
			tmp_len \
			tmp_empty \
			this
#
# CORE is loaded, lets adapt the user settings
#
	# shellcheck disable=SC1090
	source "$SWARMRC"
#
# Prepare language for user caused errors
# As well as for all helpfiles and manpages
# that the user may call/ask by ./runtime help
#
	# Only update language if LC_ALL is empty
	[[ -z "$LC_ALL" ]] && \
		swarm.update.lang && \
		swarm.update.lang.status
#
# Load the users functions now
# if he has some that is
#
	# SWARM_USER_DIR_BASE was defined the the lib-functions
	# The following the dirs should be kept to default, but can be overwritten
	# by the SWARMRC, also, SWARM_USER_DIR_BASE might have been customized
	SWARM_USER_DIR_CONF="${SWARM_USER_DIR_CONF:-${SWARM_USER_DIR_BASE}/conf}"
	SWARM_USER_DIR_LIBS="${SWARM_USER_DIR_LIBS:-${SWARM_USER_DIR_BASE}/libs}"

	if [[ -d "$SWARM_USER_DIR_BASE" ]]
	then
		# Create the dir if not existing yet (first time)
		for tDir in "$SWARM_USER_DIR_CONF" "$SWARM_USER_DIR_LIBS"
		do
			# shellcheck disable=SC2154
			$isDir >/dev/null || $MKDIR "$tDir"
		done
		# Parse and source User Files, if files exist
		# Read configuration files before functions
		for uf in "${SWARM_USER_DIR_CONF}/"* "${SWARM_USER_DIR_LIBS}/"*
		do
			# shellcheck disable=SC1090
			if [[ ! -d "$uf" ]] && [[ -f "$uf" ]]
			then
				source "$uf" && \
					$PRINTF "." || \
					init.log "$uf : $SWARM_MSG_INIT_FILE_MISSING"
			else
				init.log "$uf : $SWARM_MSG_INIT_FILE_MISSING"
			fi
		done
	fi
#
# Starting SWARM now
#
	swarm.init.theme "$SWARM_THEME"
	swarm.update.geometry
#
# Initiate Interface : Runtime Executed
#
	if [[ "runtime" = "${0##*/}" ]]
	then	# First time caller or arguments
		if [[ -z "$1" ]]
		then	# First Time // No arguments
			header 	--default
			title	"$SWARM_MSG_WELCOME_TITLE"
			status 1 "$SWARM_MSG_WELCOME_INFOLINE1"
			status 111 "$SWARM_MSG_WELCOME_INFOLINE2"
			#printe
			builtin echo "$SWARM_MSG_WELCOME_INFOLINE3" | printe -2 --
			title	"$SWARM_MSG_WORD_ARGUMENTS"
			builtin echo "$SWARM_MSG_WELCOME_CONTENT" | printe -2 -- # "TODO: Visuals, then explain, configure and stuff..."
			exit 0
		else	# Has arguments, lets parse
			$PRINTF "$(swarm.print.goto 0)"
			case "$1" in
			"basic")
				shift
				swarm.eu.show.basics
				exit $?
				;;
			"config")
				shift
				swarm.eu.show.config
				exit $?
				;;
			"demo")
				swarm.eu.demo
				exit $?
				;;
			"help" | "--help" | "-h")
				shift
				# Lets show a basic help menu
				swarm.eu.help.menu "${@}"
				exit $?
				;;
			"tarball")
				(
					# shellcheck disable=SC2164
					cd "${SWARM_DIR_ROOT}/.."
					tar -acf "$HOME/swarm-${SWARM[BUILD]}-full.tar.gz" "${SWARM_DIR_ROOT##*/}"
				)
				;;
			"tar")
				(
					# shellcheck disable=SC2164
					cd "${SWARM_DIR_ROOT}/.."
					tar -acf "$HOME/swarm-${SWARM[BUILD]}.tar.gz" --exclude ".git" "${SWARM_DIR_ROOT##*/}"
				)
				;;
			"new")
				case "$2" in
				"function")
					shift 2
					swarm.eu.new.function ${@}
					;;
				"script")
					shift 2
					swarm.eu.new.script ${@}
					;;
				*)
					swarm.eu.new.menu
					;;
				esac
				exit $?
				;;
			"words")
				title "$SWARM_MSG_WORD_WORDS"
				swarm_wordlist="$($builtin echo ${!SWARM_MSG_WORD_*})"
				declare C=0
				for this_word in $swarm_wordlist
				do
					printe "$this_word" "${!this_word}"
					C=$(( $C + 1 ))
					[[ $C -eq 10 ]] && \
						C=0 && \
						title
				done
				;;
			"stats")
			#
			#	Vars
			#
				LINER="########################################"
				COMMENTS=0
				lines=0
				BLANKS=0
			#
			#	Action
			#
				cd "$SWARM_DIR_ROOT"
				$ECHO "$LINER"
				$ECHO -e "\t$SWARM_MSG_STATS_TITLE \"${PWD##*/}\""
			# Size
				$ECHO "$LINER"
				swarm.str.dirlist . | swarm.str.dirsize -- | \
					$AWK \
						-v FOLDER="$SWARM_MSG_STATS_FOLDERS" \
						-v KB="$SWARM_MSG_WORD_KB" \
						'{print $0;SUM=SUM+$1} END {print NR" "FOLDER" "SUM/1024" "KB}' | $SED s,"${SWARM_DIR_ROOT}\/",'',g
			# Files
				$ECHO "$LINER"
				FILES=$($FIND|$GREP -ve ".git" | $WC -l)
				eval $ECHO "$SWARM_MSG_STATS_FILES"
			# Lines
				for F in $($FIND|$GREP -ve ".git" -ve ".jpg" -ve ".png" -ve ".gif")
				do	if [[ -f "$F" ]]
					then
						val_num=$(\cat "$F"|$WC -l)
						COMMENTS=$(( $COMMENTS + $($GREP ^"#" "$F" | $WC -l) ))
						lines=$(( $lines + $val_num ))
						BLANKS=$(( $BLANKS + $($GREP ^[[:space:]]$ "$F" | $WC -l) ))
					fi
				done
				$ECHO -e "$SWARM_MSG_STATS_LINES: \t\t $lines"
				$ECHO -e "$SWARM_MSG_STATS_COMMENTS: \t $COMMENTS"
				$ECHO -e "$SWARM_MSG_STATS_BLANK: \t\t $BLANKS"
				$ECHO -e "$SWARM_MSG_STATS_AVERAGE: \t $(( $lines / $FILES ))"

				cd "$OLDPWD"
			;;
			esac
		fi
	fi
#
# Exit script or beginn user scripts
#
! ${DEBUG:-false} || set +x
