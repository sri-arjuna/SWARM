#!/usr/bin/env bash
##############################################
# SWARM = Shell Wrapper and Runtime Modifier #
# Author:	Simon Arjuna Erat (sea)		 	 #
# Copyleft:	1995-2020						 #
# Created:	2020.01.18					 	 #
# Changed:	2020.03.14					 	 #
# Build:	2							  	 #
##############################################
#
# Core Public Variables
#
	# SWARM
	unset SWARM[@] ${!SWARM_DIR_*} IFS >/dev/zero
	declare -A SWARM
	# isSWARMfirstTime will be set to false if SWARMRC (~/.swarmrc) is found
	declare isSWARMfirstTime=true
	SWARM[VERSION]=0.4
	SWARM[BUILD]=7
	SWARM[AUTHOR]="Simon Arjuna Erat (sea)"
	SWARM[GIT]="http://github.com/sri-arjuna/swarm"
	SWARM[LICENSE]="LGPL"
	# This is default 'highlighted' MACHINE or ROOT display
	# Non-root users (if existing) have very hardcoded 'default-blue' (fallback) theme
	SWARM[THEME]="default-red"
	SWARM[ROOTDIR]=""
	# Language must be pre-set up until the basic language file was loaded
	SWARM[LANG]="en_GB"
	SWARM_CODE=$$
#
# Set first time default
#
#	This is just ment as failsafe if PATH is not set
#	to get the most elementary basics on/of most systems
	PATH="${PATH:-/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin:$BINDIR:$SBINDIR:$OS_DIR_BIN:$OS_DIR_SBIN}"
	# Most basic commands ; do not change!
	# This WILL be overwritten by the SWARMRC (~/.swarmrc)
	PRINTF=${PRINTF:-\printf}
	ECHO=${ECHO:-\printf}
	AWK=${AWK:-\gawk}
	GREP=${GREP:-\grep}
	SED=${SED:-\sed}
	LS=${LS:-\ls}
	PWD_EXEC=${PWD_EXEC:-\pwd}
	ID=${ID:-\id}
	DATE=${DATE:-\date}
#
# Some other things
#
	# Need to get these updating them self upon call
	# Use these to set the date variable: `
	DATE_TODAY="$DATE +%F"
	DATE_TIME="$DATE +%T"
	DATE_TIME_LOG=$($DATE +'%H:%M:%S.%s')
	init.countdown() { $PRINTF '%s\n' "${1:-Returning in 3}" ; sleep 1; $PRINTF '%s\n' "2" ; sleep 1; $PRINTF '%s\n' "1";sleep 1;$PRINTF '%s\n' "NOW" ; sleep 0.5 ; }
#
# Get proper SWARM root dir
#
	# If no SWARM_INSTALLED_DIR is provided, it is used in runtime as designed
	# However, 'SWARM_INSTALLED_DIR=$PWD source SWARM/rc' could be used as a speedbooster,
	# as it bypasses the multiple physical read attempts
	if [[ -z "${SWARM[ROOTDIR]}" ]] && [[ "x" == "x$SWARM_INSTALLED_DIR" ]]
	then
		# Find the path that holds this script
		# Evaluate best chance for the dirs
		for tmp in $0 ${PWD:-$($PWD_EXEC)} .. ${PWD:-$($PWD_EXEC)}/..
		do
				if [[ "SWARM" == "${tmp##*/}" ]]
				then	# We're in it already
						# Usualy debug or tryout mode
						SWARM[ROOTDIR]="$tmp"
						unset tmp
						break
				fi

				if [[ -d "${tmp}/SWARM" ]]
				then	# It's a sub dir
						# As it should be called
						SWARM[ROOTDIR]="$tmp/SWARM"
						unset tmp
						break
				fi
		done
		# Should not reach this point
		# Other than while debug testing
		[[ -f ./runtime ]] && SWARM[ROOTDIR]="${PWD}"
		unset tmp
	else
		# Or optionaly, use the installed method
		if [[ -d "${SWARM_INSTALLED_DIR}" ]]
		then	# Assign the variable
				SWARM[ROOTDIR]="$SWARM_INSTALLED_DIR"
		else	# This is the only hardcoded 'english only' message
				$PRINTF '%s\n' "Fatal, no SWARM dir found - assumed: \"${SWARM[ROOTDIR]}\" and you are in ${PWD:-$(${PWD_EXEC})}."
				init.countdown
				return 1
		fi
	fi
#
# SWARM_DIR_* for proper re-use
# source this file and type: SWARM_DIR_<hit tabulator>
#
	SWARM_DIR_ROOT=${SWARM[ROOTDIR]}
	SWARM_DIR_DOCS="${SWARM_DIR_ROOT}/docs"
	SWARM_DIR_DATA="${SWARM_DIR_ROOT}/data"
	SWARM_DIR_CONF="${SWARM_DIR_DATA}/conf"
	SWARM_DIR_LIBS="${SWARM_DIR_DATA}/libs"
	SWARM_DIR_LANG="${SWARM_DIR_DATA}/lang"
	SWARM_DIR_THEMES="${SWARM_DIR_DATA}/themes"
	SWARM_DIR_TEMPLATES="${SWARM_DIR_DATA}/tpl"
# Load english strings for overall coverage for error messages.
	source "$SWARM_DIR_LANG/${SWARM[LANG]}/core.txt"
#
# Load default configuration
# After this, user specific language can be loaded if available
#
	declare tmp_swarm_loading="" \
			tmp_len=0 \
			tmp_empty=""

	for this in \
			"${SWARM_DIR_CONF}"/* \
			"${SWARM_DIR_DATA}"/core/* \
			"${SWARM_DIR_LIBS}"/*
	do
		if ${doSlowLoading:-false}
		then
				# This is off by default because nowaways it's too fast to see the regular way
				# Only recomended with numbers between 0.5 to 2 for application-like scripts
				# To have a 'cool intro'
				$PRINTF '\r%s' "$this"
				[[ $tmp_len -lt ${#this} ]] && \
						tmp_len=${#this} && \
						tmp_empty=$($PRINTF '%*s' $COLUMNS)
				sleep ${SWARM_INTERVALL_SLOW_LOADING:-0.3}
				$PRINTF  "\r$tmp_empty"
		fi

		# Minimalistic output
		tmp_swarm_loading="${tmp_swarm_loading}."
		if [[ ! "${this:0:2}" == "\.[\.]" ]]
		then	#
				source "$this" && \
					$PRINTF '\r%s' "${tmp_swarm_loading}" && \
					 ( ${doLogExt:-false} && log "$SWARM_MSG_INIT_FILE_FOUND $this" ; return 0 ; ) || \
					 init.log "$SWARM_MSG_INIT_FILE_MISSING $this\n"
		else
				$PRINTF "$SWARM_MSG_INIT_FILE_MISSING $this\n"
		fi
		# Start spaming the log file, if desired

	done
	unset tmp_swarm_loading \
			tmp_len \
			tmp_empty \
			this

	# One time verification of installed commands
	# Execute the ./runtime to configure SWARM
	# or see the config: ~/.swarmrc
	#$isSWARMfirstTime && swarm.sanity.env
#
# Starting SWARM now
#
	swarm.lang.load
	swarm.init.theme
#
# Initiate Interface
#
if [[ "bash" = "$0" ]]; then
	#$ECHO
	intro_show() { #
		$ECHO " ----------- TEST AREA -----------"
		## Core sanity
		# swarm.sanity.env
		header 	--default #"a b c ${@}" #"SWARM ${SWARM[VERSION]}" " " "`$DATE_TODAY` / `$DATE_TIME`"
		title 	"my title"
		printe 	left middle right
		printe
		# Piped question works
		title	"Piped input"
		$ECHO y | ask "Is this cool?"
		$PRINTF '%s\n' $?
		$ECHO n | ask "Is this cool?"
		$PRINTF '%s\n' $?
		title	"Piped Output"
		# this is not echo, this is echo_ !
		echo_ "this is
		a piped
		test code" | printe -
		printe "this is" "an argument" "test code"
		printf "%s\n" "this was" "an argument" "test code" | printe -
		# Need a proper 'catcher' for ECHO...
		$ECHO 	left middle right | printe -
		# Of course such a hardocded would work too
		#printf '%q ' "This is" 	"another piped" 	"test run" | printe -
		#cfg.get "$SWARMRC" ECHO
	}
	#title "This is the actual 'time' result for the display part"
	time intro_show #"${@}"
	#echo ; echo "${@}" ; echo
	#time swarm.color.list
fi
#set +x
	echo " ----------- TEST AREA -----------"

	if [[ "./runtime" = "${0##/}" ]] || [[ "runtime" = "${0##/}" ]]
	then	# First time caller or arguments
			header 	"SWARM ${SWARM[VERSION]}" " " "$DATE_TODAY : $DATE_TIME"
			title	""
			printe "TODO: Visuals, then explain, configure and stuff..."
			init.countdown "Weee"
	fi
